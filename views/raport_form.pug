doctype html
html(lang='en')
head
  title= title
  meta(charset='utf-8')
  meta(name='viewport', content='width=device-width, initial-scale=1')
  link(rel="stylesheet", href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css", integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z", crossorigin="anonymous")
  link(rel='stylesheet', href='/stylesheets/style.css')
  link(href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700&amp;subset=latin-ext" rel="stylesheet")

  script(src="https://code.jquery.com/jquery-3.5.1.min.js")
  script(src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous")
    // Always remember to call the above files first before calling the bootstrap.min.js file
  script(src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous")
  script.
    // enable popovers
    $(function () {
    $('[data-toggle="popover"]').popover()
    })
  script.
    $(document).ready(function(){
      $("#addBreakdownButton").click(function(){
        $('#breakdown').after(`
        <div class="col bg-secondary text-light">
          <div class="row"> 
            <div class="col"> 
              <div class="form-group mt-2">
              <label> Numer zlecenia </label>
              <input class="form-control" type="text">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col"> 
              <select class="form-control">
              <option> Default select 1 </option>
              <option> Default select 2 </option>
              </select>
            </div>
            <div class="col">
              <select class="form-control">
              <option> Default select 3 </option>
              <option> Default select 4 </option>
              </select>
            </div>
            <div class="col"> 
              <select class="form-control">
              <option> Default select 5 </option>
              <option> Default select 6 </option>
              </select>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col">
              <label for="appt"> Godzina rozpoczęcia awarii </label>
              <input type="time" id="appt" name="appt">
            </div>
            <div class="col">
              <label for="appt-end"> Godzina zakończenia awarii </label>
              <input type="time" id="appt-end" name="appt-end">
            </div> 
          </div>
          <div class="row">
            <div class="col mt-3"> Diagnostyka
              <textarea class="form-control" rows=2 type="text"></textarea>
            </div>
          </div>
          <div class="row">
            <div class="col mt-3"> Działanie
              <textarea class="form-control" rows=2 type="text"></textarea>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col d-flex justify-content-between">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio1" value="option1">
                <label class="form-check-label" for="inlineRadio1"> Naprawiono </label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio2" value="option2">
                <label class="form-check-label" for="inlineRadio2"> Nie naprawiono </label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio3" value="option3">
                <label class="form-check-label" for="inlineRadio3"> Rozwiązanie tymczasowe </label>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col mt-3"> Uzyte części
              <textarea class="form-control" rows=1 type="text"></textarea>
            </div>
          </div>
          <div class="row">
            <div class="col mt-3"> Części do zamówienia
              <textarea class="form-control" rows=1 type="text"></textarea>
            </div>
          </div>
          <div class="row">
            <div class="col mt-3"> Prace na postój
              <textarea class="form-control" rows=1 type="text"></textarea>
            </div>
          </div>
          <hr>
        </div>`)
      })
    })
  script.
    $(document).ready(function(){
      $("#postAdditionalButton").click(function(){
        let postAdditional = {}
        postAdditional['_id'] = this.value
        postAdditional['additional'] = document.querySelector("textarea.form-control.additional").value
        $.post("", {action: "postAdditional", postAdditional: JSON.stringify(postAdditional)})
      })
    })
  script.
    $(document).ready(function() {
      $("#postPlanButton").click(function(){
        let plans = JSON.parse(this.value)

        let postPlans = []
        for(i=0; i<plans.length; i++){
          let result = {}
          result['_id'] = plans[i]._id
          result['comments'] = document.querySelector("input.form-control._" + plans[i]._id).value
          result['isDone'] = document.querySelector("input.form-check-input._" + plans[i]._id).checked

          postPlans.push(result)
        }
        $.post("", {action: 'postPlan', postPlans: JSON.stringify(postPlans)})
      }); 
    });
  script.
    $(document).ready(function() {
      $("#postPresenceButton").click(function(){
        raport = JSON.parse(this.value)

        let missing = raport.usersMissing
        let present = raport.usersPresent

        let usersMissing = []
        let usersPresent = []

        for (i=0; i<missing.length; i++){
          if (document.getElementById(missing[i]['_id']).checked)
          {
            usersPresent.push(missing[i]['_id'])
          } else {usersMissing.push(missing[i]['_id'])}
        }

        for (i=0; i<present.length; i++){
          if (document.getElementById(present[i]['_id']).checked){
            usersPresent.push(present[i]['_id'])
          } else {usersMissing.push(present[i]['_id'])}
        }
        $.post("", {action: 'postPresence', usersPresent: JSON.stringify(usersPresent), usersMissing: JSON.stringify(usersMissing), raportId: raport._id})
      }); 
    });
  script.
    $(document).ready(function() {
    $("#postPlacesButton").click(function(){
        let inspectionPlaces = [
        ['kettle', 'isKettle', 'Kotłownia'],
        ['compressor', 'isCompressor', 'Kompresownia'],
        ['ice', 'isIce', 'Wieża Chłodu'],
        ['electric', 'isElectric', 'Rozdzielnia'],
        ['workshop', 'isWorkshop', 'Warsztat'], ]

        let postPlaces = {}

        for (i=0; i<inspectionPlaces.length;i++ ){
          postPlaces[inspectionPlaces[i][0]] = document.getElementById(inspectionPlaces[i][0]).value
          postPlaces[inspectionPlaces[i][1]] = document.getElementById(inspectionPlaces[i][1]).checked
        }
        $.post("", {action: 'postInspection', postPlaces: JSON.stringify(postPlaces), inspectionId: this.value})
    }); 
    });

body
  header
    nav(class="navbar navbar-dark bg-gestampblue navbar-expand-lg")
      a(href="/api/raport" class="navbar-brand")
        img(src="https://www.gestamp.com/Gestamp11/media/GestampFiles/Logo-Gestamp-(white)02.svg" height="30" class="d-inline-block align-bottom mr-4" alt="Gestamp ಠ_ಠ")
      button(class="navbar-toggler" type="button" data-toggle="collapse" data-target="#mainmenu")
        span(class="navbar-toggler-icon")
      div(class="collapse navbar-collapse" id="mainmenu")
        ul(class="navbar-nav")
          li(class="nav-item")
            a(class="nav-link" href="/api/raport/create") Raport
          li(class="nav-item")
            a(class="nav-link" href="/api/plan") Prace Planowane
          li(class="nav-item dropdown")
            a(class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" role="button" id="device-dropdown") Menedżer urządzeń
            div(class="dropdown-menu")
              a(class="dropdown-item" href="/api/line") Linie Produkcyjne
              a(class="dropdown-item" href="/api/devicetype") Typy Urządzeń
              a(class="dropdown-item" href="/api/device") Urządzenia
          li(class="nav-item dropdown")
            a(class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" role="button" id="search-dropdown") Zarządzanie zespołem
            div(class="dropdown-menu")
              a(class="dropdown-item" href="/api/user") Pracownicy
              a(class="dropdown-item" href="/api/user/team") Skład Zmiany
          li(class="nav-item dropdown")
            a(class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" role="button" id="search-dropdown") Wyszukiwanie
            div(class="dropdown-menu")
              a(class="dropdown-item" href="search/raport") Raporty
              a(class="dropdown-item" href="/search/breakdown") Awarie

  div(class='container-fluid')
    div(class='row')
      // navbar
      aside(class='col-sm-2 my-3 umfy-vertical-navbar')

        div(class="accordion" id="accordionExample")

          div(class="card bg-gestampblue")
            div(class="card-header" id="headingReport")
              a(href="/api/raport/create")
                button(class="btn btn-link btn-block text-left  text-light" type="button")
                  | Raport

          div(class="card bg-gestampblue")
            div(class="card-header" id="headingPlan")
              a(href="/api/plan")
                button(class="btn btn-link btn-block text-left  text-light" type="button")
                  | Prace planowane


          div(class="card bg-gestampblue")
            div(class="card-header" id="headingOne")
              h2(class="mb-0")
                button(class="btn btn-link btn-block text-left collapsed text-light" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne")
                  Collapsible Menedżer urządzeń
            div(id="collapseOne" class="collapse" aria-labelledby="headingOne" data-parent="#accordionExample")
              div(class="card-body bg-light")
                a(class="dropdown-item" href="/api/line") Linie produkcyjne
                a(class="dropdown-item" href="/api/devicetype") Typy Urządzeń
                a(class="dropdown-item" href="/api/device") Urządzenia


          div(class="card bg-gestampblue")
            div(class="card-header" id="headingTwo")
              h2(class="mb-0")
                button(class="btn btn-link btn-block text-left collapsed text-light" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo")
                  Collapsible Zarządzanie zespołem
            div(id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionExample")
              div(class="card-body bg-light")
                a(class="dropdown-item" href="/api/user") Pracownicy
                a(class="dropdown-item" href="/api/user/team") Skład Zmiany

          div(class="card bg-gestampblue")
            div(class="card-header" id="headingThree")
              h2(class="mb-0")
                button(class="btn btn-link btn-block text-left collapsed text-light" type="button" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree")
                  Collapsible Wyszukiwanie
            div(id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#accordionExample")
              div(class="card-body bg-light")
                a(class="dropdown-item" href="/api/search/raport") Raporty
                a(class="dropdown-item" href="/api/search/breakdown") Awarie

      // main display
      div(class='col')
        div(class='row')
          div(class='col-lg-6 py-4')
            table(class='table table-bordered')
              caption Skład zmiany
              thead
                tr
                  th(scope="col") Imię
                  th(scope="col") Nazwisko
                  th(scope="col") Specjalizacja
                  th(scope="col") Obecny
              tbody
                // in the route when 'raport' is created, presence is not passed as an argument so it's undefined
                // checks on length prevent iterations over empty list AND if the presence is not saved for the first time, basic form generates


                if (raport.usersPresent.length != 0)
                  each user in raport.usersPresent
                    tr
                      td #{user.name}
                      td #{user.surname}
                      td #{user.spec}
                      td
                        div(class='form-check') 
                          input(class="form-check-input" type="checkbox" name=user._id value=1 id=user._id checked=true)
                if (raport.usersMissing.length != 0)
                  each user in raport.usersMissing
                    tr
                      td #{user.name}
                      td #{user.surname}
                      td #{user.spec}
                      td
                        div(class='form-check') 
                          input(class="form-check-input" type="checkbox" name=user._id value=1 id=user._id checked=false)


            div.float-right
              button(class="btn btn-primary mb-2" type='button' id='postPresenceButton' value=raport data-toggle="popover" data-placement="left" data-trigger="focus" data-content="Zapisano!") Zapisz          

            table(class="table table-bordered") 
              caption Obchód
              thead 
                tr 
                  th(scope="col") Miejsce
                  th(scope="col") Komentarz
                  th(scope="col") stan
              tbody
                each place in inspectionPlaces
                  tr
                    td #{place[2]}
                    td 
                      input(class="form-control" type="text" id=place[0] value=raport.inspection[place[0]])
                    td
                      div(class='form-check') 
                        input(class="form-check-input" type="checkbox" id=place[1] value=1 checked=raport.inspection[place[1]])
            div.float-right
              button(class="btn btn-primary mb-2" type='button' id="postPlacesButton" value=raport.inspection._id data-toggle="popover" data-placement="left" data-trigger="focus" data-content="Zapisano!") Zapisz    

            table(class='table table-bordered') 
              caption Prace Planowane
              thead 
                tr
                  th Opis
                  th Komentarz
                  th Stan
              tbody
                each item in raport.plan
                  tr
                    td #{item.desc}
                    td
                      input(class="form-control" class=("_" + item._id) type="text" value=item.comments)
                      // if css class begins with number you have to transform it into unicode like so:
                      // class='12'; document.querySelectorAll("input.form-control.\\31\\32")
                      // https://mathiasbynens.be/notes/css-escapes
                      // it's easier to add a non-numeric character at the begining of a class name
                    td
                      div(class='form-check') 
                        input(class="form-check-input" class='_'+item._id type="checkbox" value=1 checked=item.isDone)


            div.float-right
              button(class="btn btn-primary mb-2 " type='button' value=raport.plan  id="postPlanButton" data-toggle="popover" data-placement="left" data-trigger="focus" data-content="Zapisano!") Zapisz          

            
            div(class="form-group")
              // table and caption just to be consistant with the layout
              table(class='table umfy-ghost-table')
                caption Dodatkowe informacje
              textarea(class="form-control additional mt-1" rows=10 type="text") #{raport.additional}
            div.float-right
              button(class="btn btn-primary" type='button' value=raport._id  id="postAdditionalButton" data-toggle="popover" data-placement="left" data-trigger="focus" data-content="Zapisano!") Zapisz    

          // --- --- --- AWARIE --- --- ---
          div(class='col-lg-6 py-4') 
            h2 Awarie
            div(id='breakdown')
            div

            div 
              button(class="btn btn-danger my-4" type='button' id="addBreakdownButton") Dodaj    
